<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Web Browser</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  * {
    box-sizing: border-box;
    font-family: system-ui, Arial, sans-serif;
  }

  body {
    margin: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: #1e1e1e;
    color: white;
  }

  /* ===== TOP BAR ===== */
  header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px;
    background: #2b2b2b;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  button {
    background: #3a3a3a;
    border: none;
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
  }

  button:hover {
    background: #4a4a4a;
  }

  input {
    background: #111;
    color: white;
    border: none;
    border-radius: 999px;
    padding: 8px 12px;
    outline: none;
  }

  #url {
    flex: 1;
  }

  #websocket {
    width: 260px;
  }

  iframe {
    flex: 1;
    border: none;
    width: 100%;
    background: black;
  }
</style>
</head>

<body>

<header>
  <button id="back">◀</button>
  <button id="forward">▶</button>
  <button id="reload">⟳</button>

  <form id="search" style="flex:1">
    <input id="url" type="text" placeholder="Search the web or enter URL">
  </form>

  <!-- WISP INPUT (BACK IN HTML, VISIBLE) -->
  <form id="wisp">
    <input id="websocket" type="text" value="wss://gointospace.app/wisp/">
  </form>
</header>

<iframe id="iframe"></iframe>

<!-- Scramjet -->
<script src="https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/scramjet.all.js" defer></script>

<script type="module" defer>
import * as BareMux from "https://cdn.jsdelivr.net/npm/@mercuryworkshop/bare-mux/dist/index.mjs";

const iframe = document.getElementById("iframe");

/* ===== SCRAMJET INIT (UNCHANGED LOGIC) ===== */
const { ScramjetController } = $scramjetLoadController();
const scramjet = new ScramjetController({
  files: {
    wasm: "https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/wasm.wasm",
    all: "https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/scramjet.all.js",
    sync: "https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/scramjet.sync.js"
  }
});

try {
  scramjet.init();
  navigator.serviceWorker.register("/sw.js");
} catch (e) {
  console.error("Scramjet failed", e);
}

/* ===== BAREMUX + WISP ===== */
const connection = new BareMux.BareMuxConnection("/bareworker.js");

function getWispUrl() {
  return document.getElementById("websocket").value.trim()
    || "wss://gointospace.app/wisp/";
}

async function setTransport() {
  await connection.setTransport(
    "https://cdn.jsdelivr.net/npm/@mercuryworkshop/epoxy-transport/dist/index.mjs",
    [{ wisp: getWispUrl() }]
  );
}

document.getElementById("wisp").addEventListener("submit", async e => {
  e.preventDefault();
  await setTransport();
});

/* ===== SEARCH ===== */
function search(input) {
  try { return new URL(input).toString(); } catch {}
  try {
    const u = new URL("http://" + input);
    if (u.hostname.includes(".")) return u.toString();
  } catch {}
  return "https://search.brave.com/search?q=" + encodeURIComponent(input);
}

await setTransport();

/* ===== NAVIGATION ===== */
document.getElementById("search").addEventListener("submit", e => {
  e.preventDefault();
  const fixed = search(document.getElementById("url").value);
  iframe.src = scramjet.encodeUrl(fixed);
});

document.getElementById("back").onclick = () =>
  iframe.contentWindow?.history.back();

document.getElementById("forward").onclick = () =>
  iframe.contentWindow?.history.forward();

document.getElementById("reload").onclick = () =>
  iframe.contentWindow?.location.reload();

/* ===== START PAGE ===== */
iframe.src = scramjet.encodeUrl("https://example.com");
</script>

</body>
</html>
