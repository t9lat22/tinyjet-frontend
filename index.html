<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Browser</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  * {
    box-sizing: border-box;
    font-family: system-ui, Arial, sans-serif;
  }

  body {
    margin: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: #1e1e1e;
    color: white;
  }

  header {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px;
    background: #2b2b2b;
  }

  button {
    background: #3a3a3a;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
  }

  button:hover {
    background: #4a4a4a;
  }

  input {
    background: #111;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px;
    outline: none;
  }

  #url {
    flex: 1;
  }

  #websocket {
    width: 260px;
  }

  iframe {
    flex: 1;
    border: none;
    width: 100%;
    background: black;
  }

  #status {
    padding: 4px 8px;
    font-size: 12px;
    background: #222;
    color: #aaa;
  }
</style>
</head>

<body>

<header>
  <button id="back">◀</button>
  <button id="forward">▶</button>
  <button id="reload">⟳</button>
  <button id="home">⌂</button>

  <form id="search" style="flex:1">
    <input id="url" type="text" placeholder="Search the web or enter URL">
  </form>

  <form id="wisp">
    <input id="websocket" type="text" value="wss://gointospace.app/wisp/">
  </form>

  <button id="applyWisp">Apply</button>
</header>

<iframe id="iframe"></iframe>

<div id="status">Ready</div>

<script src="https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/scramjet.all.js"></script>

<script type="module">
import * as BareMux from "https://cdn.jsdelivr.net/npm/@mercuryworkshop/bare-mux/dist/index.mjs";

const { ScramjetController } = $scramjetLoadController();
const scramjet = new ScramjetController({
  files: {
    wasm: "https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/wasm.wasm",
    all: "https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/scramjet.all.js",
    sync: "https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/scramjet.sync.js"
  }
});

scramjet.init();
navigator.serviceWorker.register("/sw.js");

const connection = new BareMux.BareMuxConnection("/bareworker.js");

const iframe = document.getElementById("iframe");
const urlInput = document.getElementById("url");
const wispInput = document.getElementById("websocket");
const status = document.getElementById("status");

/* ===== WISP ===== */
async function setTransport() {
  const wisp = wispInput.value.trim() || "wss://gointospace.app/wisp/";
  await connection.setTransport(
    "https://cdn.jsdelivr.net/npm/@mercuryworkshop/epoxy-transport/dist/index.mjs",
    [{ wisp }]
  );
  status.textContent = "Wisp: " + wisp;
}

document.getElementById("applyWisp").onclick = setTransport;
await setTransport();

/* ===== URL FIXER ===== */
function fixUrl(input) {
  try {
    return new URL(input).toString();
  } catch {}

  try {
    const u = new URL("http://" + input);
    if (u.hostname.includes(".")) return u.toString();
  } catch {}

  return "https://search.brave.com/search?q=" + encodeURIComponent(input);
}

/* ===== NAVIGATION ===== */
function navigate(input) {
  const fixed = fixUrl(input);
  iframe.src = scramjet.encodeUrl(fixed);
  urlInput.value = fixed;
  status.textContent = "Loading...";
}

document.getElementById("search").addEventListener("submit", e => {
  e.preventDefault();
  navigate(urlInput.value);
});

document.getElementById("back").onclick = () => iframe.contentWindow.history.back();
document.getElementById("forward").onclick = () => iframe.contentWindow.history.forward();
document.getElementById("reload").onclick = () => iframe.contentWindow.location.reload();
document.getElementById("home").onclick = () => navigate("https://example.com");

iframe.addEventListener("load", () => {
  status.textContent = "Loaded";
});

/* ===== START PAGE ===== */
navigate("https://example.com");
</script>

</body>
</html>
