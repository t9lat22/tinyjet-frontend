<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Browser</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  * {
    box-sizing: border-box;
    font-family: system-ui, Arial, sans-serif;
  }

  body {
    margin: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: #1e1e1e;
    color: white;
  }

  header {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px;
    background: #2b2b2b;
  }

  button {
    background: #3a3a3a;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
  }

  input {
    background: #111;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px;
    outline: none;
  }

  #url { flex: 1; }
  #websocket { width: 260px; }

  iframe {
    flex: 1;
    border: none;
    width: 100%;
    background: black;
  }
</style>
</head>

<body>

<header>
  <button onclick="iframe.contentWindow.history.back()">◀</button>
  <button onclick="iframe.contentWindow.history.forward()">▶</button>
  <button onclick="iframe.contentWindow.location.reload()">⟳</button>

  <form id="search" style="flex:1">
    <input id="url" type="text" placeholder="Search the web or enter URL">
  </form>

  <form id="wisp">
    <input id="websocket" type="text" value="wss://gointospace.app/wisp/">
  </form>
</header>

<iframe id="iframe"></iframe>

<!-- IMPORTANT: same script loading as your working version -->
<script src="https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/scramjet.all.js" defer></script>

<script type="module" defer>
import * as BareMux from "https://cdn.jsdelivr.net/npm/@mercuryworkshop/bare-mux/dist/index.mjs";

/* ===== SAME SCRAMJET INIT AS BEFORE ===== */
const { ScramjetController } = $scramjetLoadController();
const scramjet = new ScramjetController({
  files: {
    wasm: "https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/wasm.wasm",
    all: "https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/scramjet.all.js",
    sync: "https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/scramjet.sync.js"
  }
});

try {
  scramjet.init();
  navigator.serviceWorker.register("/sw.js");
} catch (e) {
  console.error("scramjet failed", e);
}

/* ===== SAME BAREMUX SETUP ===== */
const connection = new BareMux.BareMuxConnection("/bareworker.js");

function getWispUrl() {
  return document.getElementById("websocket").value.trim()
    || "wss://gointospace.app/wisp/";
}

async function setTransport() {
  await connection.setTransport(
    "https://cdn.jsdelivr.net/npm/@mercuryworkshop/epoxy-transport/dist/index.mjs",
    [{ wisp: getWispUrl() }]
  );
}

/* ===== APPLY WISP (UNCHANGED BEHAVIOR) ===== */
document.getElementById("wisp").addEventListener("submit", async e => {
  e.preventDefault();
  await setTransport();
});

/* ===== SEARCH LOGIC (UNCHANGED) ===== */
function search(input) {
  try { return new URL(input).toString(); } catch {}
  try {
    const u = new URL("http://" + input);
    if (u.hostname.includes(".")) return u.toString();
  } catch {}
  return "https://search.brave.com/search?q=" + encodeURIComponent(input);
}

/* ===== INITIALIZE PROXY FIRST ===== */
await setTransport();

/* ===== NAVIGATION ===== */
document.getElementById("search").addEventListener("submit", e => {
  e.preventDefault();
  const fixed = search(document.getElementById("url").value);
  iframe.src = scramjet.encodeUrl(fixed);
});

/* ===== START PAGE ===== */
iframe.src = scramjet.encodeUrl("https://example.com");
</script>

</body>
</html>
