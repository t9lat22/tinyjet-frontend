<head>
  <title>TinyJet Proxy</title>
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/mercuryworkshop/scramjet-app@latest/public/favicon.ico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@100..800&display=swap" rel="stylesheet">
</head>
<body class="default">
  <header>
    <form id="search"><input id="url" type="text" class="search-input search" placeholder="Search the web or enter URL"></form>
    <span id="gear"><i class="fa">&#xf013;</i></span>
  </header>
  <div id="overlay">
    <div id="settings">
      <h3>Settings</h3>
        <h4>WISP Server</h4>
        <form id="wispInput">
          <input id="websocket" type="text" placeholder="wss://gointospace.app/wisp/" value="wss://gointospace.app/wisp/">
          <button type="submit">Set WISP</button>
        </form>
      <h4>Transport Protocol</h4>
      <label>
        <input type="radio" name="transport" value="epoxy" checked> Epoxy (Default)
      </label><br>
      <label>
        <input type="radio" name="transport" value="libcurl"> Libcurl
      </label>
      <h4>Theme</h4>
      <select id="themePicker">
        <option value="default">Default</option>
        <option value="latte">Catppuccin Latte</option>
        <option value="frappe">Catppuccin Frappe</option>
        <option value="macchiato">Catppuccin Macchiato</option>
        <option value="mocha">Catppuccin Mocha</option>
        <option value="mrworkshop">Mr. Workshop</option>
        <option value="aerialite">Aerialite Labs</option>
      </select>
    </div>
  </div>
  <iframe id="iframe" width="100%"></iframe>

  <script src="https://cdn.jsdelivr.net/gh/AerialiteLabs/tinyjet-frontend@latest/tinyjet/scramjet.all.js" defer></script>
  <script type="module" defer>
    import * as BareMux from "https://cdn.jsdelivr.net/gh/AerialiteLabs/tinyjet-frontend@latest/tinyjet/index.mjs";

    const { ScramjetController } = $scramjetLoadController();
    const scramjet = new ScramjetController({ 
      files: { 
        wasm: "https://cdn.jsdelivr.net/gh/AerialiteLabs/tinyjet-frontend@latest/tinyjet/wasm.wasm", 
        all: "https://cdn.jsdelivr.net/gh/AerialiteLabs/tinyjet-frontend@latest/tinyjet/scramjet.all.js", 
        sync: "https://cdn.jsdelivr.net/gh/AerialiteLabs/tinyjet-frontend@latest/tinyjet/scramjet.sync.js" 
      } 
    });

    try {
      scramjet.init();
      const sw = `data:application/javascript;base64,aW1wb3J0U2NyaXB0cygiaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L2doL3NvYXAtcGhpYS90aW55amV0QGxhdGVzdC90aW55amV0L3NjcmFtamV0LmFsbC5qcyIpOwpjb25zdCB7IFNjcmFtamV0U2VydmljZVdvcmtlciB9ID0gJHNjcmFtamV0TG9hZFdvcmtlcigpOwpjb25zdCBzY3JhbWpldCA9IG5ldyBTY3JhbWpldFNlcnZpY2VXb3JrZXIoKQphc3luYyBmdW5jdGlvbiBoYW5kbGVSZXF1ZXN0KGV2ZW50KSB7CiAgYXdhaXQgc2NyYW1qZXQubG9hZENvbmZpZygpCiAgaWYgKHNjcmFtamV0LnJvdXRlKGV2ZW50KSkge3JldHVybiBhd2FpdCBzY3JhbWpldC5mZXRjaChldmVudCl9CiAgcmV0dXJuIGF3YWl0IGZldGNoKGV2ZW50LnJlcXVlc3QpCn0Kc2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIChldmVudCkgPT4ge2V2ZW50LnJlc3BvbmRXaXRoKGhhbmRsZVJlcXVlc3QoZXZlbnQpKX0p`;
      navigator.serviceWorker.register("./sw.js");
    } catch (e) { console.error("scramjet failed to initialize;", e); }

    const bareworker = `data:application/javascript;base64,IWZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO2NvbnN0IGU9TWVzc2FnZVBvcnQucHJvdG90eXBlLnBvc3RNZXNzYWdlO2xldCB0PW51bGw7ZnVuY3Rpb24gYShlLHQsYSl7Y29uc29sZS5lcnJvcihgZXJyb3Igd2hpbGUgcHJvY2Vzc2luZyAnJHthfSc6IGAsdCksZS5wb3N0TWVzc2FnZSh7dHlwZToiZXJyb3IiLGVycm9yOnR9KX1hc3luYyBmdW5jdGlvbiBuKGEsbixzKXtjb25zdCBvPWF3YWl0IHMucmVxdWVzdChuZXcgVVJMKGEuZmV0Y2gucmVtb3RlKSxhLmZldGNoLm1ldGhvZCxhLmZldGNoLmJvZHksYS5mZXRjaC5oZWFkZXJzLG51bGwpO2lmKCFmdW5jdGlvbigpe2lmKG51bGw9PT10KXtjb25zdCBhPW5ldyBNZXNzYWdlQ2hhbm5lbCxuPW5ldyBSZWFkYWJsZVN0cmVhbTtsZXQgczt0cnl7ZS5jYWxsKGEucG9ydDEsbixbbl0pLHM9ITB9Y2F0Y2goZSl7cz0hMX1yZXR1cm4gdD1zLHN9cmV0dXJuIHR9KCkmJm8uYm9keSBpbnN0YW5jZW9mIFJlYWRhYmxlU3RyZWFtKXtjb25zdCBlPW5ldyBSZXNwb25zZShvLmJvZHkpO28uYm9keT1hd2FpdCBlLmFycmF5QnVmZmVyKCl9by5ib2R5IGluc3RhbmNlb2YgUmVhZGFibGVTdHJlYW18fG8uYm9keSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyP2UuY2FsbChuLHt0eXBlOiJmZXRjaCIsZmV0Y2g6b30sW28uYm9keV0pOmUuY2FsbChuLHt0eXBlOiJmZXRjaCIsZmV0Y2g6b30pfWxldCBzPW51bGwsbz0iIjtmdW5jdGlvbiBjKCl7cmV0dXJuIG5ldyBFcnJvcigidGhlcmUgYXJlIG5vIGJhcmUgY2xpZW50cyIse2NhdXNlOiJObyBCYXJlVHJhbnNwb3J0IHdhcyBzZXQuIFRyeSBjcmVhdGluZyBhIEJhcmVNdXhDb25uZWN0aW9uIGFuZCBjYWxsaW5nIHNldFRyYW5zcG9ydCgpIG9yIHNldE1hbnVhbFRyYW5zcG9ydCgpIG9uIGl0IGJlZm9yZSB1c2luZyBCYXJlQ2xpZW50LiJ9KX1mdW5jdGlvbiByKHQsYSl7Y29uc3Qgbj1zO2xldCBvPVthXTt0LmZldGNoPy5ib2R5JiZvLnB1c2godC5mZXRjaC5ib2R5KSx0LndlYnNvY2tldD8uY2hhbm5lbCYmby5wdXNoKHQud2Vic29ja2V0LmNoYW5uZWwpLGUuY2FsbChuLHttZXNzYWdlOnQscG9ydDphfSxvKX1mdW5jdGlvbiBsKHQpe3Qub25tZXNzYWdlPWFzeW5jIHQ9Pntjb25zdCBsPXQuZGF0YS5wb3J0LGk9dC5kYXRhLm1lc3NhZ2U7aWYoInBpbmciPT09aS50eXBlKWUuY2FsbChsLHt0eXBlOiJwb25nIn0pO2Vsc2UgaWYoInNldCI9PT1pLnR5cGUpdHJ5e2NvbnN0IHQ9YXN5bmMgZnVuY3Rpb24oKXt9LmNvbnN0cnVjdG9yO2lmKCJiYXJlLW11eC1yZW1vdGUiPT09aS5jbGllbnQuZnVuY3Rpb24pcz1pLmNsaWVudC5hcmdzWzBdLG89YGJhcmUtbXV4LXJlbW90ZSAoJHtpLmNsaWVudC5hcmdzWzFdfSlgO2Vsc2V7Y29uc3QgZT1uZXcgdChpLmNsaWVudC5mdW5jdGlvbiksW2Esbl09YXdhaXQgZSgpO3M9bmV3IGEoLi4uaS5jbGllbnQuYXJncyksbz1ufWNvbnNvbGUubG9nKCJzZXQgdHJhbnNwb3J0IHRvICIscyxvKSxlLmNhbGwobCx7dHlwZToic2V0In0pfWNhdGNoKGUpe2EobCxlLCJzZXQiKX1lbHNlIGlmKCJnZXQiPT09aS50eXBlKWwucG9zdE1lc3NhZ2Uoe3R5cGU6ImdldCIsbmFtZTpvfSk7ZWxzZSBpZigiZmV0Y2giPT09aS50eXBlKXRyeXtpZighcyl0aHJvdyBjKCk7aWYocyBpbnN0YW5jZW9mIE1lc3NhZ2VQb3J0KXJldHVybiB2b2lkIHIoaSxsKTtzLnJlYWR5fHxhd2FpdCBzLmluaXQoKSxhd2FpdCBuKGksbCxzKX1jYXRjaChlKXthKGwsZSwiZmV0Y2giKX1lbHNlIGlmKCJ3ZWJzb2NrZXQiPT09aS50eXBlKXRyeXtpZighcyl0aHJvdyBjKCk7aWYocyBpbnN0YW5jZW9mIE1lc3NhZ2VQb3J0KXJldHVybiB2b2lkIHIoaSxsKTtzLnJlYWR5fHxhd2FpdCBzLmluaXQoKSxhd2FpdCBhc3luYyBmdW5jdGlvbih0LGEsbil7Y29uc3RbcyxvXT1uLmNvbm5lY3QobmV3IFVSTCh0LndlYnNvY2tldC51cmwpLHQud2Vic29ja2V0LnByb3RvY29scyx0LndlYnNvY2tldC5yZXF1ZXN0SGVhZGVycywoYT0+e2UuY2FsbCh0LndlYnNvY2tldC5jaGFubmVsLHt0eXBlOiJvcGVuIixhcmdzOlthXX0pfSksKGE9PnthIGluc3RhbmNlb2YgQXJyYXlCdWZmZXI/ZS5jYWxsKHQud2Vic29ja2V0LmNoYW5uZWwse3R5cGU6Im1lc3NhZ2UiLGFyZ3M6W2FdfSxbYV0pOmUuY2FsbCh0LndlYnNvY2tldC5jaGFubmVsLHt0eXBlOiJtZXNzYWdlIixhcmdzOlthXX0pfSksKChhLG4pPT57ZS5jYWxsKHQud2Vic29ja2V0LmNoYW5uZWwse3R5cGU6ImNsb3NlIixhcmdzOlthLG5dfSl9KSwoYT0+e2UuY2FsbCh0LndlYnNvY2tldC5jaGFubmVsLHt0eXBlOiJlcnJvciIsYXJnczpbYV19KX0pKTt0LndlYnNvY2tldC5jaGFubmVsLm9ubWVzc2FnZT1lPT57ImRhdGEiPT09ZS5kYXRhLnR5cGU/cyhlLmRhdGEuZGF0YSk6ImNsb3NlIj09PWUuZGF0YS50eXBlJiZvKGUuZGF0YS5jbG9zZUNvZGUsZS5kYXRhLmNsb3NlUmVhc29uKX0sZS5jYWxsKGEse3R5cGU6IndlYnNvY2tldCJ9KX0oaSxsLHMpfWNhdGNoKGUpe2EobCxlLCJ3ZWJzb2NrZXQiKX19fW5ldyBCcm9hZGNhc3RDaGFubmVsKCJiYXJlLW11eCIpLnBvc3RNZXNzYWdlKHt0eXBlOiJyZWZyZXNoUG9ydCJ9KSxzZWxmLm9uY29ubmVjdD1lPT57bChlLnBvcnRzWzBdKX0sY29uc29sZS5kZWJ1ZygiYmFyZS1tdXg6IHJ1bm5pbmcgdjIuMS43IChidWlsZCBjNTZkMjg2KSIpfSgpOwovLyMgc291cmNlTWFwcGluZ1VSTD13b3JrZXIuanMubWFw`;
    const connection = new BareMux.BareMuxConnection(bareworker);

    const settings = document.getElementById("settings");
    const gear = document.getElementById("gear");
    const overlay = document.getElementById("overlay"); 
    const wispInput = document.getElementById("wispInput");
    const transports = document.querySelectorAll('input[name="transport"]');
    const themePicker = document.getElementById('themePicker');

    gear.onclick = () => { overlay.classList.toggle("active"); settings.classList.toggle("open") }
    overlay.onclick = e => { if (e.target === overlay) overlay.classList.remove("active"); settings.classList.remove("open") }
    document.onkeydown = e => { if (e.key === "Escape") { overlay.classList.remove("active"); settings.classList.remove("open") } }

    function getWispUrl() {
      const wisp = document.getElementById("websocket").value.trim();
      const defaultWisp = "wss://gointospace.app/wisp/";
      return wisp || defaultWisp;
    }

    async function setTransport(transportsel) {
      const wispUrl = getWispUrl();
      localStorage.setItem('selectedTransport', transportsel);
      switch (transportsel) {
        case "epoxy":
          await connection.setTransport("https://cdn.jsdelivr.net/npm/@mercuryworkshop/epoxy-transport/dist/index.mjs", [{ wisp: wispUrl }]);
          break;
        case "libcurl":
          await connection.setTransport("https://cdn.jsdelivr.net/npm/@mercuryworkshop/libcurl-transport/dist/index.mjs", [{ websocket: wispUrl }]);
          break;
        default:
          await connection.setTransport("https://cdn.jsdelivr.net/npm/@mercuryworkshop/epoxy-transport/dist/index.mjs", [{ wisp: wispUrl }]);
          break;
      }
    }

    function search(input) {
      let template = "https://search.brave.com/search?q=%s";

      try {
        return new URL(input).toString();
      } catch (err) {}

      try {
        let url = new URL(`http://${input}`);
        if (url.hostname.includes(".")) return url.toString();
      } catch (err) {}

      return template.replace("%s", input); 
    }

    const currentWisp = localStorage.getItem('selectedWisp') || "wss://gointospace.app/wisp/";
    const currentTransport = localStorage.getItem('selectedTransport') || "epoxy";
    const currentTheme = localStorage.getItem('selectedTheme') || "default";

    document.getElementById("websocket").value = currentWisp;
    document.querySelector(`input[value="${currentTransport}"]`).checked = true;
    themePicker.value = currentTheme;
    document.body.className = currentTheme;

    setTransport(currentTransport); 
        
    wispInput.addEventListener("submit", async (event) => {
      event.preventDefault();
      const newWisp = document.getElementById("websocket").value.trim();
      localStorage.setItem('selectedWisp', newWisp);
      const currentTransport = document.querySelector('input[name="transport"]:checked').value;
      await setTransport(currentTransport);
    });

    transports.forEach(radio => {
      radio.addEventListener('change', async (event) => {
        await setTransport(event.target.value);
      });
    });

    themePicker.addEventListener('change', (event) => {
      const selectedTheme = event.target.value;
      document.body.className = selectedTheme;
      localStorage.setItem('selectedTheme', selectedTheme);
    });
    
    document.getElementById("search").addEventListener("submit", async (event) => {
      event.preventDefault();
      let fixedurl = search(document.getElementById("url").value);
      let src;
      src = scramjet.encodeUrl(fixedurl);
      document.getElementById("iframe").src = src;
    });
  </script>
</body>